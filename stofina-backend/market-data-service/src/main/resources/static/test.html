<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Market Data WebSocket Test</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #priceUpdates { border: 1px solid #ccc; padding: 10px; height: 400px; overflow-y: scroll; margin-top: 10px; }
        .price-update { margin: 5px 0; padding: 5px; border-left: 3px solid #007bff; }
        .positive { border-left-color: #28a745; }
        .negative { border-left-color: #dc3545; }
    </style>
</head>
<body>
<h1>Market Data WebSocket Test</h1>
<button id="connectBtn">Connect to WebSocket</button>
<button id="disconnectBtn" disabled>Disconnect</button>
<button id="subscribeBtn" disabled>Subscribe to THYAO</button>

<div id="connectionStatus">Status: Disconnected</div>
<div id="priceUpdates"></div>

<script>
    let stompClient = null;
    let isConnected = false;

    const connectBtn = document.getElementById('connectBtn');
    const disconnectBtn = document.getElementById('disconnectBtn');
    const subscribeBtn = document.getElementById('subscribeBtn');
    const statusDiv = document.getElementById('connectionStatus');
    const updatesDiv = document.getElementById('priceUpdates');

    connectBtn.onclick = function () {
      const socket = new SockJS('http://localhost:8080/ws');
      stompClient = Stomp.over(socket);

      stompClient.connect({}, function (frame) {
        console.log('Connected: ' + frame);
        statusDiv.textContent = 'Status: Connected';
        isConnected = true;
        updateButtons();

        // Subscribe to all prices
        stompClient.subscribe('/topic/prices', function (message) {
          const priceData = JSON.parse(message.body);
          displayPriceUpdate(priceData);
        });

        // Subscribe to specific symbol (THYAO)
        stompClient.subscribe('/topic/prices/THYAO', function (message) {
          const priceData = JSON.parse(message.body);
          displayPriceUpdate(priceData, 'THYAO specific');
        });

      }, function (error) {
        console.error('Connection error:', error);
        statusDiv.textContent = 'Status: Connection Error';
        updateButtons();
      });
    };

    disconnectBtn.onclick = function () {
      if (stompClient !== null) {
        stompClient.disconnect();
        statusDiv.textContent = 'Status: Disconnected';
        isConnected = false;
        updateButtons();
      }
    };

    subscribeBtn.onclick = function () {
      if (stompClient && isConnected) {
        // Send subscription request to server
        stompClient.send('/app/subscribe', {}, JSON.stringify({ symbol: 'THYAO' }));
        addLogMessage('Sent subscription request for THYAO');
      }
    };

    function updateButtons() {
      connectBtn.disabled = isConnected;
      disconnectBtn.disabled = !isConnected;
      subscribeBtn.disabled = !isConnected;
    }

    function displayPriceUpdate(data, source = '') {
      const div = document.createElement('div');
      div.className = 'price-update';
      
      if (data.changePercent > 0) {
        div.classList.add('positive');
      } else if (data.changePercent < 0) {
        div.classList.add('negative');
      }

      const sourceText = source ? ` (${source})` : '';
      div.innerHTML = `
        <strong>${data.symbol}${sourceText}</strong><br>
        Price: ${data.price} TL<br>
        Change: ${data.changeAmount} (${data.changePercent}%)<br>
        Time: ${new Date(data.timestamp).toLocaleTimeString()}
      `;
      
      updatesDiv.insertBefore(div, updatesDiv.firstChild);
      
      // Keep only last 50 updates
      while (updatesDiv.children.length > 50) {
        updatesDiv.removeChild(updatesDiv.lastChild);
      }
    }

    function addLogMessage(message) {
      const div = document.createElement('div');
      div.className = 'price-update';
      div.innerHTML = `<em>${message} - ${new Date().toLocaleTimeString()}</em>`;
      updatesDiv.insertBefore(div, updatesDiv.firstChild);
    }
</script>
</body>
</html>
